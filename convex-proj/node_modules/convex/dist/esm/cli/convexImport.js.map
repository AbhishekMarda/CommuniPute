{
  "version": 3,
  "sources": ["../../../src/cli/convexImport.ts"],
  "sourcesContent": ["import { Command, Option } from \"commander\";\nimport chalk from \"chalk\";\nimport { readProjectConfig } from \"./lib/config\";\nimport {\n  ensureHasConvexDependency,\n  fatalServerErr,\n  formatSize,\n} from \"./lib/utils\";\nimport axios, { AxiosResponse } from \"axios\";\nimport { version } from \"../index.js\";\nimport { getUrlAndAdminKey } from \"./lib/api\";\nimport { oneoffContext } from \"./lib/context\";\n\nexport const convexImport = new Command(\"import\")\n  .description(\"Import data from a file into a Convex table\")\n  .addOption(\n    new Option(\n      \"--format <format>\",\n      \"Input file format. This flag is only required if the filename is missing an extension.\\\n      CSV files must have a header, and each rows' entries are interpreted either as a (floating point) number or a string.\\\n      JSONLines files must have a JSON object per line. JSON files must be an array of JSON objects.\"\n    ).choices([\"csv\", \"jsonLines\", \"jsonArray\"])\n  )\n  .option(\n    \"--prod\",\n    \"Import data into this project's production deployment. Defaults to your dev deployment without this flag.\"\n  )\n  .addOption(\n    new Option(\"--replace\", \"Replace any existing data in the table\").conflicts(\n      \"--append\"\n    )\n  )\n  .addOption(\n    new Option(\n      \"--append\",\n      \"Append to any existing data in the table\"\n    ).conflicts(\"--replace\")\n  )\n  .addOption(new Option(\"--url <url>\").hideHelp())\n  .addOption(new Option(\"--admin-key <adminKey>\").hideHelp())\n  .argument(\"<tableName>\", \"Destination table name\")\n  .argument(\"<path>\", \"Path to the input file\")\n  .action(async (tableName: string, path: string, options: any) => {\n    const ctx = oneoffContext;\n    let format = options.format;\n    const pathParts = path.split(\".\");\n    if (pathParts.length > 1) {\n      const fileType = pathParts[pathParts.length - 1];\n      let inferredFormat;\n      switch (fileType) {\n        case \"csv\":\n          inferredFormat = \"csv\";\n          break;\n        case \"jsonl\":\n          inferredFormat = \"jsonLines\";\n          break;\n        case \"json\":\n          inferredFormat = \"jsonArray\";\n          break;\n      }\n      if (format && format !== inferredFormat) {\n        throw new Error(\n          `Format of file ${path} does not match specified format: ${format}`\n        );\n      }\n      format = inferredFormat;\n    }\n    if (!format) {\n      throw new Error(\n        \"No input file format inferred by the filename extension or specified. Specify your input file's format using the `--format` flag.\"\n      );\n    }\n    const { projectConfig } = await readProjectConfig(ctx);\n    const deploymentType = options.prod ? \"prod\" : \"dev\";\n    let deploymentUrl, adminKey;\n    if (!options.url || !options.adminKey) {\n      let url;\n      ({ url, adminKey } = await getUrlAndAdminKey(\n        ctx,\n        projectConfig.project,\n        projectConfig.team,\n        deploymentType\n      ));\n      deploymentUrl = url;\n    }\n    adminKey = options.adminKey ?? adminKey;\n    deploymentUrl = options.url ?? deploymentUrl;\n    await ensureHasConvexDependency(ctx, \"import\");\n\n    if (!ctx.fs.exists(path)) {\n      console.error(chalk.gray(`Error: Path ${path} does not exist.`));\n      return await ctx.fatalError(1, \"fs\");\n    }\n    const data = ctx.fs.createReadStream(path);\n    const fileStats = ctx.fs.stat(path);\n    console.log(\n      chalk.gray(`Importing ${path} (${formatSize(fileStats.size)})...`)\n    );\n    const urlName = encodeURIComponent(tableName);\n    const urlFormat = encodeURIComponent(format);\n    const client = axios.create();\n    let resp: AxiosResponse;\n    let mode = \"requireEmpty\";\n    if (options.append) {\n      mode = \"append\";\n    } else if (options.replace) {\n      mode = \"replace\";\n    }\n    try {\n      const url = `${deploymentUrl}/api/${version}/import?tableName=${urlName}&format=${urlFormat}&mode=${mode}`;\n      resp = await client.post(url, data, {\n        headers: {\n          Authorization: `Convex ${adminKey}`,\n          \"Content-Type\": \"text/plain\",\n        },\n      });\n    } catch (e) {\n      return await fatalServerErr(ctx, e);\n    }\n    console.log(\n      chalk.green(`Wrote ${resp.data.numWritten} rows to ${tableName}.`)\n    );\n  });\n"],
  "mappings": "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",
  "names": []
}
