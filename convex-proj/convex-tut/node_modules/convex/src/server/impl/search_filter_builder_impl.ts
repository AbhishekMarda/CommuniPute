import { convexToJson, JSONValue } from "../../values/values.js";
import {
  FieldTypeFromFieldPath,
  GenericDocument,
  GenericSearchIndexConfig,
} from "../data_model.js";
import {
  SearchFilter,
  SearchFilterBuilder,
  SearchFilterFinalizer,
} from "../search_filter_builder.js";

export type SerializedSearchFilter =
  | {
      type: "Search";
      fieldPath: string;
      value: string;
    }
  | {
      type: "Eq";
      fieldPath: string;
      value: JSONValue;
    };

export class SearchFilterBuilderImpl
  extends SearchFilter
  implements
    SearchFilterBuilder<GenericDocument, GenericSearchIndexConfig>,
    SearchFilterFinalizer<GenericDocument, GenericSearchIndexConfig>
{
  private filters: ReadonlyArray<SerializedSearchFilter>;
  private isConsumed: boolean;
  private constructor(filters: ReadonlyArray<SerializedSearchFilter>) {
    super();
    this.filters = filters;
    this.isConsumed = false;
  }

  static new(): SearchFilterBuilderImpl {
    return new SearchFilterBuilderImpl([]);
  }

  private consume() {
    if (this.isConsumed) {
      throw new Error(
        "SearchFilterBuilder has already been used! Chain your method calls like `q => q.search(...).eq(...)`."
      );
    }
    this.isConsumed = true;
  }

  search(
    fieldName: string,
    query: string
  ): SearchFilterFinalizer<GenericDocument, GenericSearchIndexConfig> {
    this.consume();
    return new SearchFilterBuilderImpl(
      this.filters.concat({
        type: "Search",
        fieldPath: fieldName,
        value: query,
      })
    );
  }
  eq<FieldName extends string>(
    fieldName: FieldName,
    value: FieldTypeFromFieldPath<GenericDocument, FieldName>
  ): SearchFilterFinalizer<GenericDocument, GenericSearchIndexConfig> {
    this.consume();
    return new SearchFilterBuilderImpl(
      this.filters.concat({
        type: "Eq",
        fieldPath: fieldName,
        value: convexToJson(value),
      })
    );
  }

  export() {
    this.consume();
    return this.filters;
  }
}
